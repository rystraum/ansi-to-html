#!/usr/bin/env ruby
# vim: set ft=ruby:

# Usage:
# $ tmux capture-pane -S -10000  -e; tmux show-buffer > /tmp/terminal
# $ ansi-to-html /tmp/terminal > /tmp/foo.html
# $ cat /tmp/terminal | ansi-to-html > /tmp/bar.html
# $ tmux capture-pane -S -10000  -e; tmux show-buffer | ansi-to-html > /tmp/baz.html

require File.expand_path("../../lib/ansi-to-html.rb", __FILE__)
require "optparse"

opt = OptionParser.new
generate_full_html = true

colors = {
  :fg => "#fff",
  :bg => "#000",
  :pallete => :linux
}
opt.on('-n', '--no-html') { |v| generate_full_html = false }
opt.on('-f VAL', '--fg=VAL') {|v| colors[:fg] = v }
opt.on('-b VAL', '--bg=VAL') {|v| colors[:bg] = v }
opt.on('-p VAL', '--pallete=VAL') {|v| colors[:pallete] = v.to_sym }
opt.parse! ARGV

if ARGF.to_io == STDIN && !File.pipe?(STDIN)
  warn "any file or stdin needed."
  exit
end

ansi = Ansi::To::Html.new(ARGF)

charset = case Encoding.locale_charmap.downcase
when "eucjp"
  "euc-jp"
when "sjis","cp932"
  "Shift_JIS"
when "utf-8","utf8"
  "utf-8"
else
  "utf-8"
end

if generate_full_html
  puts "<html><head>"
  puts %Q!<meta charset="#{charset}" />!
  puts "<!-- generated by ansi-to-html #{Ansi::To::Html::VERSION} https://github.com/uu59/ansi-to-html -->"
  puts %Q!</head><body style="color:#{colors[:fg]};background-color:#{colors[:bg]}">!
  puts "<pre>"
end

puts ansi.to_html(colors[:pallete])

if generate_full_html
  puts "</pre>"
  puts "</body></html>"
end